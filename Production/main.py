from kmk.kmk_keyboard import KMKKeyboard
from kmk.keys import KC
from kmk.modules.layers import Layers
from kmk.modules.oled import OLED, SSD1306
import board
import busio
import time

keyboard = KMKKeyboard()
layers_mod = Layers()
keyboard.modules = [layers_mod]

i2c = busio.I2C(board.GP15, board.GP14)
oled = OLED(SSD1306(i2c, width=128, height=32))
keyboard.modules.append(oled)

keyboard.col_pins = (board.GP0, board.GP1, board.GP2, board.GP3)
keyboard.row_pins = (board.GP4, board.GP5, board.GP6, board.GP7)
keyboard.diode_orientation = keyboard.DiodeOrientation.COL2ROW

keyboard.keymap = [
    [
        KC.TG(1), KC.B, KC.C, KC.D,
        KC.E, KC.F, KC.G, KC.H,
        KC.I, KC.J, KC.K, KC.L,
        KC.M, KC.N, KC.O, KC.P
    ],
    [
        KC.TG(2), KC.B, KC.C, KC.D,
        KC.E, KC.F, KC.G, KC.H,
        KC.I, KC.J, KC.K, KC.L,
        KC.M, KC.N, KC.O, KC.P
    ],
    [
        KC.TG(0), KC.B, KC.C, KC.D,
        KC.E, KC.F, KC.G, KC.H,
        KC.I, KC.J, KC.K, KC.L,
        KC.M, KC.N, KC.O, KC.P
    ]
]

sleeping = True
sleep_frame_index = 0
last_frame_time = 0

mode_names = {
    0: "DRAWING",
    1: "GAME",
    2: "BLENDER"
}

# Your OLED arrays
GOBER_SILLY = [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF8, 0x80, 0x00, 0x80,
    0x20, 0x02, 0x03, 0xE3, 0x00, 0x00, 0x88, 0x44, 0x44, 0x41, 0x42, 0x84, 0x02, 0x00, 0x40, 0x60,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x01, 0x80, 0x80, 0x80, 0x00,
    0x08, 0x0E, 0x08, 0x00, 0x24, 0x23, 0x20, 0x06, 0x08, 0x08, 0x18, 0x08, 0x08, 0x03, 0x00, 0x00,
    0x00, 0x18, 0xC8, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
    0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04
]

GOBER_SLEEP_FRAMES = [
    [
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF8, 0x80, 0x00, 0x01,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 0x02, 0x00, 0x40, 0x60,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3C, 0x01, 0x80, 0x80, 0x80, 0x01,
        0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00,
        0x00, 0x18, 0xC8, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
        0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04
    ],
    [
        0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x08, 0x04, 0x00,
        0x02, 0x02, 0x00, 0x02, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x08, 0x04, 0x04, 0x84, 0xC8,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x02, 0x00, 0x00, 0x01, 0x02,
        0x02, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x04, 0x0C, 0x04, 0x04, 0x04, 0x0C, 0x04, 0x00, 0x00,
        0x20, 0x60, 0x11, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0E,
        0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08
    ]
]

# Tiny 8x8 font
FONT8x8 = {
    'A':[0x18,0x24,0x42,0x7E,0x42,0x42,0x42,0x00],
    'B':[0x7C,0x42,0x42,0x7C,0x42,0x42,0x7C,0x00],
    'D':[0x78,0x44,0x42,0x42,0x42,0x44,0x78,0x00],
    'E':[0x7E,0x40,0x40,0x7C,0x40,0x40,0x7E,0x00],
    'G':[0x3C,0x42,0x40,0x4E,0x42,0x42,0x3C,0x00],
    'L':[0x40,0x40,0x40,0x40,0x40,0x40,0x7E,0x00],
    'N':[0x42,0x62,0x52,0x4A,0x46,0x42,0x42,0x00],
    'R':[0x7C,0x42,0x42,0x7C,0x48,0x44,0x42,0x00],
    'W':[0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00],
    ' ': [0x00]*8
}

def draw_char_scaled(oled, char, x, y, scale=2):
    if char not in FONT8x8:
        char = ' '
    bitmap = FONT8x8[char]
    for row in range(8):
        bits = bitmap[row]
        for col in range(8):
            if (bits >> (7-col)) & 1:
                for dy in range(scale):
                    for dx in range(scale):
                        oled.pixel(x + col*scale + dx, y + row*scale + dy, 1)

def draw_text_scaled(oled, text, x=0, y=0, scale=2):
    for i, c in enumerate(text):
        draw_char_scaled(oled, c, x + i*8*scale, y, scale)

def draw_bitmap(oled, bitmap, width=128, height=32):
    for y in range(height):
        for x in range(width):
            byte_index = x + (y // 8) * width
            bit_index = y % 8
            if byte_index < len(bitmap) and (bitmap[byte_index] >> bit_index) & 1:
                oled.pixel(x, y, 1)

def update_oled(oled):
    global sleeping, sleep_frame_index, last_frame_time
    now = time.monotonic()
    current_layer = layers_mod.active_layers[-1]
    oled.fill(0)

    key_pressed = False
    for r, row in enumerate(keyboard.switch_matrix):
        for c, switch in enumerate(row):
            if switch and not (r == 0 and c == 0):  # skip mode key
                key_pressed = True
                break
        if key_pressed:
            break

    if key_pressed:
        draw_bitmap(oled, GOBER_SILLY)
        sleeping = False
    else:
        sleeping = True
        if now - last_frame_time > 0.5:
            sleep_frame_index = (sleep_frame_index + 1) % len(GOBER_SLEEP_FRAMES)
            last_frame_time = now
        draw_bitmap(oled, GOBER_SLEEP_FRAMES[sleep_frame_index])

    # Draw the mode name scaled to reasonable size
    draw_text_scaled(oled, mode_names[current_layer], 0, 8, scale=2)  # 16px tall letters
    oled.show()

keyboard.add_periodic_task(update_oled, 0.1)

if __name__ == '__main__':
    keyboard.go()
